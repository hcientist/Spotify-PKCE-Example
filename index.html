<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <button id="begin">Get Spotify Auth</button>
  <script>
  // code verifier
  function generateRandomString(length) {
    let text = '';
    let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

    for (let i = 0; i < length; i++) {
      text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
  }

  // Code Challenge
  



    // getting code from uri
    const urlParams = new URLSearchParams(window.location.search);
    let code = urlParams.get('code');
    console.log('got code! ðŸ™Œ', code)

    const button = document.getElementById('begin')
    button.addEventListener('click', async ()=>{
      console.log('get token')

      const digest = await window.crypto.subtle.digest('SHA-256', data);

      async function generateCodeChallenge(codeVerifier) {
        function base64encode(string) {
          return btoa(String.fromCharCode.apply(null, new Uint8Array(string)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
        }

        const encoder = new TextEncoder();
        const data = encoder.encode(codeVerifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);

        return base64encode(digest);
      }

      const clientId = '2a6b7c52c7b34693bc60f0620512d363';
      const redirectUri = 'https://w3.cs.jmu.edu/stewarmc/343/s23/pkce';

      let codeVerifier = generateRandomString(128);

      generateCodeChallenge(codeVerifier).then(codeChallenge => {
        let state = generateRandomString(16);
        let scope = 'user-read-private user-read-email';

        localStorage.setItem('code_verifier', codeVerifier);

        let args = new URLSearchParams({
          response_type: 'code',
          client_id: clientId,
          scope: scope,
          redirect_uri: redirectUri,
          state: state,
          code_challenge_method: 'S256',
          code_challenge: codeChallenge
        });

        window.location = 'https://accounts.spotify.com/authorize?' + args;
      });

    })
  </script>
</body>
</html>